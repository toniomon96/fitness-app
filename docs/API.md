# Omnexus API Reference

All API endpoints are Vercel serverless functions located in `/api/`. They run on Node.js 20 and are only accessible server-side — the `ANTHROPIC_API_KEY` is never exposed to the client.

---

## Base URL

| Environment | URL |
|---|---|
| Local | `http://localhost:3000/api` |
| Production | `https://<your-vercel-domain>/api` |

---

## Endpoints

### POST /api/ask

Sends a health or fitness question to Claude and returns an evidence-based answer with citations.

**Request**

```http
POST /api/ask
Content-Type: application/json
```

```json
{
  "question": "How much protein do I need to build muscle?",
  "userContext": {
    "goal": "hypertrophy",
    "experienceLevel": "intermediate"
  }
}
```

| Field | Type | Required | Notes |
|---|---|---|---|
| `question` | `string` | Yes | Max 1000 characters |
| `userContext` | `object` | No | Appended as a light annotation to the prompt |
| `userContext.goal` | `"hypertrophy" \| "fat-loss" \| "general-fitness"` | No | |
| `userContext.experienceLevel` | `"beginner" \| "intermediate" \| "advanced"` | No | |

**Response `200`**

```json
{
  "answer": "Protein needs for muscle building typically range from **1.6–2.2 g per kg of bodyweight** per day...\n\n⚠️ This is educational information only, not medical advice..."
}
```

| Field | Type | Notes |
|---|---|---|
| `answer` | `string` | Markdown-formatted text. Always ends with the safety disclaimer. |

**Error Responses**

| Status | Body | Cause |
|---|---|---|
| `400` | `{ "error": "question is required" }` | Missing or empty question |
| `400` | `{ "error": "Question too long (max 1000 characters)" }` | Question exceeds limit |
| `405` | `{ "error": "Method not allowed" }` | Non-POST request |
| `500` | `{ "error": "<message>" }` | Claude API failure |

**Claude model:** `claude-sonnet-4-6` · `max_tokens: 1024`

---

### POST /api/insights

Analyzes a user's recent workout history and returns personalized, evidence-based training insights.

**Request**

```http
POST /api/insights
Content-Type: application/json
```

```json
{
  "userGoal": "hypertrophy",
  "userExperience": "intermediate",
  "workoutSummary": "Sessions in last 4 weeks: 12\nAverage session volume: 4200 kg\n\nSession log (most recent first):\nFri, Jan 24: 4500 kg volume, 55 min — Bench Press, Squat, Deadlift\n..."
}
```

| Field | Type | Required | Notes |
|---|---|---|---|
| `userGoal` | `string` | No | Defaults to `"general fitness"` |
| `userExperience` | `string` | No | Defaults to `"beginner"` |
| `workoutSummary` | `string` | Yes | Plain-text summary generated by `insightsService.ts` |

The `workoutSummary` is built client-side by [`src/services/insightsService.ts`](../src/services/insightsService.ts), which:
- Filters sessions to the last 28 days (max 20)
- Calculates total and average volume
- Lists each session with date, volume, duration, and top 3 exercises

**Response `200`**

```json
{
  "insight": "**Training Overview**\nYour training over the past 4 weeks shows strong consistency...\n\n**Observations**\n- ...\n\n**Recommendations**\n1. ...\n\n⚠️ These insights are educational only..."
}
```

| Field | Type | Notes |
|---|---|---|
| `insight` | `string` | Markdown-formatted. Contains Training Overview, Observations, and Recommendations sections. |

**Error Responses**

| Status | Body | Cause |
|---|---|---|
| `400` | `{ "error": "workoutSummary is required" }` | Missing or non-string body field |
| `405` | `{ "error": "Method not allowed" }` | Non-POST request |
| `500` | `{ "error": "<message>" }` | Claude API failure |

**Claude model:** `claude-sonnet-4-6` · `max_tokens: 1024`

---

### GET /api/articles

Fetches recent peer-reviewed research articles from PubMed for a given fitness category. Results are returned without caching at the API layer — caching is handled client-side in `localStorage` with a 6-hour TTL.

**Request**

```http
GET /api/articles?category=strength-training&limit=5
```

| Parameter | Type | Required | Default | Notes |
|---|---|---|---|---|
| `category` | `string` | No | `strength-training` | See valid values below |
| `limit` | `number` | No | `5` | Max `10` |

**Valid `category` values**

| Value | PubMed search focus |
|---|---|
| `strength-training` | Resistance training, hypertrophy, strength gains |
| `nutrition` | Sports nutrition, protein intake, macronutrients |
| `recovery` | Exercise recovery, DOMS, muscle repair |
| `sleep` | Sleep quality, athletic performance |
| `metabolic-health` | Metabolic health, insulin sensitivity, body composition |
| `cardio` | Aerobic exercise, cardiovascular fitness, HIIT |
| `mobility` | Flexibility, mobility, stretching, range of motion |

**Response `200`**

```json
{
  "articles": [
    {
      "id": "38563521",
      "title": "Dose-response relationship between weekly resistance training volume and increases in muscle mass",
      "summary": "We conducted a systematic review and meta-analysis to evaluate the dose-response relationship...",
      "keyTakeaways": [],
      "source": "Schoenfeld BJ et al. — Journal of Strength and Conditioning Research",
      "sourceUrl": "https://pubmed.ncbi.nlm.nih.gov/38563521/",
      "publishedDate": "2024 Mar",
      "category": "strength-training",
      "tags": [],
      "cachedAt": "2025-01-24T14:30:00.000Z"
    }
  ]
}
```

| Field | Type | Notes |
|---|---|---|
| `id` | `string` | PubMed ID (PMID) |
| `title` | `string` | Article title, trailing period removed |
| `summary` | `string` | Abstract text, truncated to 400 chars |
| `keyTakeaways` | `string[]` | Currently empty — reserved for future Claude summarization |
| `source` | `string` | `"First Author et al. — Journal Name"` |
| `sourceUrl` | `string` | Direct PubMed link |
| `publishedDate` | `string` | As returned by PubMed (e.g. `"2024 Mar"`) |
| `category` | `LearningCategory` | Echoes the request category |
| `tags` | `string[]` | Currently empty — reserved for MeSH terms |
| `cachedAt` | `string` | ISO timestamp of when the API generated this response |

Articles without an abstract are filtered out.

**Error Responses**

| Status | Body | Cause |
|---|---|---|
| `400` | `{ "error": "Invalid category" }` | Unrecognised category value |
| `405` | `{ "error": "Method not allowed" }` | Non-GET request |
| `500` | `{ "error": "<message>" }` | PubMed API failure |

**External APIs used (server-side only)**

| PubMed endpoint | Purpose |
|---|---|
| `esearch.fcgi` | Find PMIDs for a text query, sorted by relevance, filtered to last 5 years |
| `esummary.fcgi` | Fetch title, authors, journal, publication date (JSON) |
| `efetch.fcgi` | Fetch full XML to extract abstract text |

---

## System Prompt

Both `/api/ask` and `/api/insights` use a shared AI persona:

```
You are Omnexus AI, a health and fitness education assistant.

ALWAYS:
- Root answers in peer-reviewed research and established guidelines (ACSM, WHO, NIH, ISSN)
- Cite sources inline: [Author et al., Year — Journal]
- Explain the "why" behind recommendations
- Acknowledge uncertainty or conflicting evidence
- Use accessible, plain language

NEVER:
- Diagnose, prescribe, or treat medical conditions
- Recommend extreme diets, dangerous training, or harmful practices
- Make guarantees about personal outcomes
- Replace qualified healthcare professionals
```

Every response ends with:
> ⚠️ This is educational information only, not medical advice. Consult a qualified healthcare professional for personal health concerns.

---

## Client-Side Services

These files call the API endpoints from the React app:

| File | Calls | Responsibility |
|---|---|---|
| [`src/services/claudeService.ts`](../src/services/claudeService.ts) | `/api/ask`, `/api/insights` | Typed `fetch()` wrappers |
| [`src/services/insightsService.ts`](../src/services/insightsService.ts) | — | Builds the `workoutSummary` string from `WorkoutSession[]` |
| [`src/services/pubmedService.ts`](../src/services/pubmedService.ts) | `/api/articles` | Calls API + manages 6 h localStorage cache per category |
